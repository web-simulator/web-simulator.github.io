(function(){"use strict";function U(o,p,_,e){if(!o||o.length===0)return 0;const l=Math.max(...o),r=l-_;if(r<.2)return 0;const a=l-r*.9;let i=-1,n=-1;for(let s=0;s<o.length;s++)if(o[s]>=l*.98){i=s;break}if(i===-1)return 0;for(let s=i;s<o.length;s++)if(o[s]<=a){n=s;break}return n===-1?0:(n-i)*p}const V={endo:{u_o:0,u_u:1.56,theta_v:.3,theta_w:.13,theta_vminus:.2,theta_o:.006,tau_v1minus:75,tau_v2minus:10,tau_vplus:1.4506,tau_w1minus:6,tau_w2minus:140,k_wminus:200,u_wminus:.016,tau_wplus:280,tau_fi:.15,tau_o1:470,tau_o2:6,tau_so1:40,tau_so2:1.2,k_so:2,u_so:.65,tau_s1:2.7342,tau_s2:2,k_s:2.0994,u_s:.9087,tau_si:2.9013,tau_winf:.0273,w_infstar:.78},myo:{u_o:0,u_u:1.61,theta_v:.3,theta_w:.13,theta_vminus:.1,theta_o:.005,tau_v1minus:80,tau_v2minus:1.4506,tau_vplus:1.4506,tau_w1minus:70,tau_w2minus:8,k_wminus:200,u_wminus:.016,tau_wplus:280,tau_fi:.117,tau_o1:410,tau_o2:7,tau_so1:91,tau_so2:.8,k_so:2.1,u_so:.6,tau_s1:2.7342,tau_s2:4,k_s:2.0994,u_s:.9087,tau_si:3.3849,tau_winf:.01,w_infstar:.5},epi:{u_o:0,u_u:1.55,theta_v:.3,theta_w:.13,theta_vminus:.006,theta_o:.006,tau_v1minus:60,tau_v2minus:1150,tau_vplus:1.4506,tau_w1minus:60,tau_w2minus:15,k_wminus:65,u_wminus:.03,tau_wplus:200,tau_fi:.165,tau_o1:400,tau_o2:6,tau_so1:30.0181,tau_so2:.9957,k_so:2.0458,u_so:.65,tau_s1:2.7342,tau_s2:16,k_s:2.0994,u_s:.9087,tau_si:1.8875,tau_winf:.07,w_infstar:.94}};function _t(o,p){const{dt:_,inicio:e,duracao:l,amplitude:r,BCL_S1:a,intervalo_S2:i,num_estimulos_s1:n}=o,{u_o:s,u_u:B,theta_v:m,theta_w:d,theta_vminus:g,theta_o:f,tau_v1minus:w,tau_v2minus:I,tau_vplus:J,tau_w1minus:C,tau_w2minus:F,k_wminus:z,u_wminus:T,tau_wplus:j,tau_fi:h,tau_o1:b,tau_o2:L,tau_so1:u,tau_so2:ut,k_so:at,u_so:nt,tau_s1:ot,tau_s2:it,k_s:et,u_s:lt,tau_si:ct,tau_winf:rt,w_infstar:mt}=p,ft=e+(n-1)*a+i+1.5*a,v=parseInt(ft/_,10),k=new Float32Array(v),E=new Float32Array(v),R=new Float32Array(v),q=new Float32Array(v),G=new Float32Array(v);let t=0,M=1,S=1,x=0;k[0]=t,E[0]=M,R[0]=S,q[0]=x,G[0]=0;for(let c=1;c<v;c++){const y=c*_;G[c]=y;let K=0;for(let Q=0;Q<n;Q++){const st=e+Q*a;if(y>=st&&y<st+l){K=r;break}}const Z=e+(n-1)*a+i;y>=Z&&y<Z+l&&(K=r);const pt=t-m>0?1:0,A=t-d>0?1:0,$=t-g>0?1:0,P=t-f>0?1:0,vt=(1-$)*w+$*I,dt=C+(F-C)*(1+Math.tanh(z*(t-T)))*.5,gt=u+(ut-u)*(1+Math.tanh(at*(t-nt)))*.5,kt=(1-A)*ot+A*it,Mt=(1-P)*b+P*L,St=-M*pt*(t-m)*(B-t)/h,xt=(t-s)*(1-A)/Mt+A/gt,yt=-A*S*x/ct,At=-(St+xt+yt)+K,Ct=t+At*_,Ft=t<g?1:0;let N,D;t>=m?(N=J,D=0):(N=vt,D=Ft);const bt=D+(M-D)*Math.exp(-_/N),Lt=(1-P)*(1-t/rt)+P*mt;let O,H;t>=d?(O=j,H=0):(O=dt,H=Lt);const Pt=H+(S-H)*Math.exp(-_/O),tt=(1+Math.tanh(et*(t-lt)))*.5,Dt=tt+(x-tt)*Math.exp(-_/kt);t=Ct,M=bt,S=Pt,x=Dt,k[c]=t,E[c]=M,R[c]=S,q[c]=x}const W=Math.round((e+(n-1)*a)/_),X=Math.round(1.5*a/_),wt=k.slice(W,W+X),Y=Math.round((e+(n-1)*a+i)/_),ht=k.slice(Y,Y+X);return{u_s1:wt,u_s2:ht,full_u:k,full_v:E,full_w:R,full_s:q,full_tempo:G}}self.onmessage=o=>{const p=o.data,{BCL_S2_inicial:_,BCL_S2_final:e,delta_CL:l,downsamplingFactor:r,cellType:a="epi",dt:i,minimalCellParams:n}=p;let s;n&&n[a]?s=n[a]:s=V[a]||V.epi;const B=Math.floor((_-e)/l)+1,m=[],d=[];let g=0;for(let f=0;f<B;f++){const w=_-f*l;if(w<e)continue;const I={...p,intervalo_S2:w},{u_s1:J,u_s2:C,full_u:F,full_v:z,full_w:T,full_s:j,full_tempo:h}=_t(I,s),b=U(J,i,0),L=U(C,i,0);if(b>0&&L>0){const u=w-b;u>0&&m.push({bcl:u,apd:L})}for(let u=0;u<F.length;u+=r)h[u]!==void 0&&d.push({tempo:(g+h[u]).toFixed(2),v:F[u],gate_v:z[u],gate_w:T[u],gate_s:j[u]});h.length>0&&(g+=h[h.length-1])}m.sort((f,w)=>f.bcl-w.bcl),self.postMessage({timeSeriesData:d,restitutionData:m})}})();
