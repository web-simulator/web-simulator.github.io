(function(){"use strict";function P(s,c){if(!s||s.length===0)return 0;const r=Math.max(...s),p=Math.min(...s),f=r-p;if(f<.2)return 0;const M=r-f*.9;let t=-1,l=-1;for(let n=0;n<s.length;n++)if(s[n]>=r*.98){t=n;break}if(t===-1)return 0;for(let n=t;n<s.length;n++)if(s[n]<=M){l=n;break}return l===-1?0:(l-t)*c}function q(s){const{tau_in:c,tau_out:r,tau_open:p,tau_close:f,v_gate:M,dt:t,v_inicial:l,h_inicial:n,inicio:_,duracao:b,amplitude:g,BCL_S1:i,intervalo_S2:v,num_estimulos_s1:u}=s,h=_+(u-1)*i+v+1.5*i,a=parseInt(h/t,10),d=new Array(a).fill(l),A=new Array(a).fill(n),y=new Array(a);for(let e=1;e<a;e++){y[e]=e*t;const o=y[e];let D=0;for(let x=0;x<u;x++){const B=_+x*i;if(o>=B&&o<B+b){D=g;break}}const j=_+(u-1)*i+v;o>=j&&o<j+b&&(D=g);const C=d[e-1],I=A[e-1],E=I*C**2*(1-C)/c,G=-C/r,H=E+G+D,K=C+H*t;let k,R;C<M?(k=1/p,R=0):(k=0,R=1/f);const z=k+R;let J;if(z>0){const x=k/z,B=Math.exp(-z*t);J=x+(I-x)*B}else J=I;d[e]=Math.max(0,Math.min(1,K)),A[e]=Math.max(0,Math.min(1,J))}const w=Math.round((_+(u-1)*i)/t),F=Math.round(1.5*i/t),m=d.slice(w,w+F),S=Math.round((_+(u-1)*i+v)/t),L=d.slice(S,S+F);return{v_s1:m,v_s2:L,full_v:d,full_h:A,full_tempo:y}}self.onmessage=s=>{const c=s.data,{BCL_S2_inicial:r,BCL_S2_final:p,delta_CL:f,downsamplingFactor:M}=c,t=Math.floor((r-p)/f)+1,l=[],n=[],_=[],b=[];let g=0;for(let h=0;h<t;h++){const a=r-h*f;if(a<p)continue;const d={...c,intervalo_S2:a},{v_s1:A,v_s2:y,full_v:w,full_h:F,full_tempo:m}=q(d),S=P(A,c.dt),L=P(y,c.dt);if(S>0&&L>0){const o=a-S;o>0&&l.push({bcl:o,apd:L})}const e=w.length;for(let o=0;o<e;o+=M)m[o]!==void 0&&(n.push(g+m[o]),_.push(w[o]),b.push(F[o]));m.length>0&&(g+=m[m.length-1])}l.sort((h,a)=>h.bcl-a.bcl);const i=new Float32Array(n),v=new Float32Array(_),u=new Float32Array(b);self.postMessage({timeSeriesData:{time:i,v,h:u},restitutionData:l},[i.buffer,v.buffer,u.buffer])}})();
