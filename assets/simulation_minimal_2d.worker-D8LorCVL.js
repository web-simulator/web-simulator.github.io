(function(){"use strict";class Ct{constructor(j=Date.now()){this.seed=j%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=this.seed*16807%2147483647,this.seed/2147483647}nextInt(j,v){return j>v&&([j,v]=[v,j]),Math.floor(this.next()*(v-j+1))+j}}const Rt={u_o:0,theta_v:.3,theta_w:.13,tau_vplus:1.4506,tau_s1:2.7342,k_s:2.0994,u_s:.9087};self.onmessage=ft=>{const j=ft.data,{sigma_l:v,sigma_t:at,angle:Ht,L:et,N:a,totalTime:St,downsamplingFactor:ht,stimuli:qt,fibrosisParams:ot,transmuralityParams:K,cellType:Jt,minimalCellParams:U}=j;let{dt:C}=j;const c=et/a,y=c,g=a*a,Mt=Ht*Math.PI/180,nt=Math.cos(Mt),it=Math.sin(Mt),dt=nt*nt,xt=it*it,Nt=nt*it,Q=v*dt+at*xt,V=v*xt+at*dt,W=(v-at)*Nt,Bt=4*Math.max(Q,V)+2*Math.abs(W),pt=c*c/(Bt||1);C>pt&&(C=pt*.9);let f=new Float32Array(g).fill(0),rt=new Float32Array(g).fill(1),lt=new Float32Array(g).fill(1),ct=new Float32Array(g).fill(0),q=new Float32Array(g).fill(Q),J=new Float32Array(g).fill(V),N=new Float32Array(g).fill(W),H=new Float32Array(g).fill(v);if(ot&&ot.enabled){const{conductivity:e,type:h,distribution:S,shape:L,rectParams:O,circleParams:D,regionParams:T,borderZone:_=0,seed:n,density:l}=ot,s=(t,o,i)=>t*(1-i)+o*i;if(h==="compact"&&S==="region")if(L==="rectangle"){const{x1:t,y1:o,x2:i,y2:r}=O,M=Math.min(t,i),w=Math.max(t,i),P=Math.min(o,r),I=Math.max(o,r),A=M-_,d=w+_,b=P-_,x=I+_,m=Math.max(0,Math.floor(b/y)),p=Math.min(a-1,Math.floor(x/y)),u=Math.max(0,Math.floor(A/c)),Y=Math.min(a-1,Math.floor(d/c));for(let k=m;k<=p;k++)for(let R=u;R<=Y;R++){const z=k*y,$=R*c,F=k*a+R,tt=Math.max(M-$,0,$-w),st=Math.max(P-z,0,z-I),G=Math.sqrt(tt*tt+st*st);if(G===0)q[F]=e,J[F]=e,N[F]=0,H[F]=e;else if(G<=_){const E=G/_;q[F]=s(e,Q,E),J[F]=s(e,V,E),N[F]=s(0,W,E),H[F]=s(e,v,E)}}}else{const{cx:t,cy:o,radius:i}=D,r=i+_,M=Math.max(0,Math.floor((o-r)/y)),w=Math.min(a-1,Math.floor((o+r)/y)),P=Math.max(0,Math.floor((t-r)/c)),I=Math.min(a-1,Math.floor((t+r)/c));for(let A=M;A<=w;A++)for(let d=P;d<=I;d++){const b=A*y,x=d*c,m=A*a+d,p=Math.sqrt((x-t)**2+(b-o)**2);if(p<=i)q[m]=e,J[m]=e,N[m]=0,H[m]=e;else if(p<=r){const u=(p-i)/_;q[m]=s(e,Q,u),J[m]=s(e,V,u),N[m]=s(0,W,u),H[m]=s(e,v,u)}}}else{const t=new Ct(n);let o,i,r,M,w;const P=c*y;if(h==="diffuse"&&T){const{x1:d,y1:b,x2:x,y2:m}=T;i=Math.floor(Math.min(b,m)/y),r=Math.floor(Math.max(b,m)/y),M=Math.floor(Math.min(d,x)/c),w=Math.floor(Math.max(d,x)/c);const p=Math.abs(x-d)*Math.abs(m-b);o=Math.ceil(p*l/P)}else i=0,r=a-1,M=0,w=a-1,o=Math.ceil(et*et*l/P);i=Math.max(0,i),r=Math.min(a-1,r),M=Math.max(0,M),w=Math.min(a-1,w);let I=0,A=0;for(;I<o&&A<o*5;){A++;const d=t.nextInt(i,r),b=t.nextInt(M,w),x=d*a+b;q[x]=e,J[x]=e,N[x]=0,H[x]=e,I++}}}const yt=[],_t=[];let wt=0;qt.forEach((e,h)=>{let S=new Uint8Array(g).fill(0);if(e.shape==="rectangle"){const{x1:D,y1:T,x2:_,y2:n}=e.rectParams,l=Math.floor(T/y),s=Math.floor(D/c),t=Math.floor(n/y),o=Math.floor(_/c);for(let i=Math.min(l,t);i<=Math.max(l,t);i++)for(let r=Math.min(s,o);r<=Math.max(s,o);r++)i>=0&&i<a&&r>=0&&r<a&&(S[i*a+r]=1)}else{const{cx:D,cy:T,radius:_}=e.circleParams,n=_*_;for(let l=0;l<a;l++)for(let s=0;s<a;s++)(s*c-D)**2+(l*y-T)**2<=n&&(S[l*a+s]=1)}yt.push(S);let L=h===0?e.startTime:wt+e.interval;const O=L+e.duration;wt=O,_t.push({startTime:L,endTime:O,amplitude:e.amplitude})});const Z=Math.floor(St/C),vt=Math.floor(Z/ht)+1,ut=new Float32Array(vt*g),mt=new Float32Array(vt);let X=0;const gt=1/(c*c),Lt=1/(4*c*c),Ot=Math.max(1,Math.floor(Z/100)),zt=performance.now(),{u_o:Et,theta_v:At,theta_w:Ut,tau_vplus:B,tau_s1:Zt,k_s:Gt,u_s:Kt}=Rt,bt=K&&K.enabled;let Ft=null;bt||(Ft=U[Jt]||U.epi);for(let e=0;e<Z;e++){if(e%Ot===0){const n=Math.round(e/Z*100);let l=0;if(e>0){const s=performance.now()-zt;l=(Z-e)*(s/e)}self.postMessage({type:"progress",value:n,remaining:l})}const h=new Float32Array(f),S=new Float32Array(rt),L=new Float32Array(lt),O=new Float32Array(ct),D=e*C;let T=0,_=null;for(let n=0;n<_t.length;n++){const l=_t[n];if(D>=l.startTime&&D<l.endTime){T=l.amplitude,_=yt[n];break}}for(let n=1;n<a-1;n++)for(let l=1;l<a-1;l++){const s=n*a+l;let t;if(bt){const kt=l/a,Wt=K.mid_start/100,Xt=K.epi_start/100;kt<Wt?t=U.endo:kt<Xt?t=U.myo:t=U.epi}else t=Ft;const o=h[s],i=S[s],r=L[s],M=O[s],w=q[s],P=J[s],I=N[s],A=(h[s-1]-2*o+h[s+1])*gt,d=(h[s-a]-2*o+h[s+a])*gt,b=(h[s+a+1]-h[s+a-1]-h[s-a+1]+h[s-a-1])*Lt,x=w*A+P*d+2*I*b,m=_?_[s]*T:0,p=o-At>0?1:0,u=o-Ut>0?1:0,Y=o-t.theta_vminus>0?1:0,k=o-t.theta_o>0?1:0,R=(1-Y)*t.tau_v1minus+Y*t.tau_v2minus,z=t.tau_w1minus+(t.tau_w2minus-t.tau_w1minus)*(1+Math.tanh(t.k_wminus*(o-t.u_wminus)))*.5,$=t.tau_so1+(t.tau_so2-t.tau_so1)*(1+Math.tanh(t.k_so*(o-t.u_so)))*.5,F=(1-u)*Zt+u*t.tau_s2,tt=(1-k)*t.tau_o1+k*t.tau_o2,st=-i*p*(o-At)*(t.u_u-o)/t.tau_fi,G=(o-Et)*(1-u)/tt+u/$,E=-u*r*M/t.tau_si;f[s]=o+C*(x-(st+G+E)+m);const Qt=o<t.theta_vminus?1:0,jt=B*R/(B-B*p+R*p),Dt=B*Qt*(1-p)/(B-B*p+R*p);jt>1e-10?rt[s]=Dt+(i-Dt)*Math.exp(-C/jt):rt[s]=i;const Vt=(1-k)*(1-o/t.tau_winf)+k*t.w_infstar,Tt=t.tau_wplus*z/(t.tau_wplus-t.tau_wplus*u+z*u),Pt=t.tau_wplus*Vt*(1-u)/(t.tau_wplus-t.tau_wplus*u+z*u);Tt>1e-10?lt[s]=Pt+(r-Pt)*Math.exp(-C/Tt):lt[s]=r;const It=(1+Math.tanh(Gt*(o-Kt)))*.5;F>1e-10?ct[s]=It+(M-It)*Math.exp(-C/F):ct[s]=M,f[s]<0&&(f[s]=0),f[s]>2&&(f[s]=2)}for(let n=0;n<a;n++)f[n*a]=f[n*a+1],f[n*a+a-1]=f[n*a+a-2];for(let n=0;n<a;n++)f[n]=f[a+n],f[(a-1)*a+n]=f[(a-2)*a+n];e%ht===0&&(ut.set(f,X*g),mt[X]=D,X++)}self.postMessage({type:"result",frames:ut,times:mt,fibrosis:H,N:a,totalFrames:X},[ut.buffer,mt.buffer,H.buffer])}})();
