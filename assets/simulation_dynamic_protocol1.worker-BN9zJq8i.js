(function(){"use strict";function B(n,M){if(!n||n.length===0)return 0;const i=Math.max(...n),b=Math.min(...n),_=i-b;if(_<.2)return 0;const g=i-_*.9;let s=-1,o=-1;for(let a=0;a<n.length;a++)if(n[a]>=i*.98){s=a;break}if(s===-1)return 0;for(let a=s;a<n.length;a++)if(n[a]<=g){o=a;break}return o===-1?0:(o-s)*M}self.onmessage=n=>{const M=n.data,{tau_in:i,tau_out:b,tau_open:_,tau_close:g,v_gate:s,dt:o,v_inicial:a,h_inicial:E,inicio:z,duracao:G,amplitude:H,CI1:I,CI0:F,CIinc:J,nbeats:v,downsamplingFactor:K}=M,L=Math.floor((I-F)/J)+1,N=z+L*v*I,u=parseInt(N/o,10),p=new Array(u).fill(a),w=new Array(u).fill(E),f=new Array(u).fill(0),A=[];let e=1,j=z,h=0;for(let t=I;t>=F;t-=J)for(let c=0;c<v;c++){const m=j,O=m+G,Q=m+t,S=Math.round(m/o);for(;e*o<Q&&e<u;){f[e]=e*o;const l=f[e],U=l>=m&&l<O?H:0,r=p[e-1],C=w[e-1],V=C*r**2*(1-r)/i,W=-r/b,X=V+W+U,Y=r+X*o;let x,y;r<s?(x=1/_,y=0):(x=0,y=1/g);const D=x+y;let k;if(D>0){const q=x/D,Z=Math.exp(-D*o);k=q+(C-q)*Z}else k=C;p[e]=Math.max(0,Math.min(1,Y)),w[e]=Math.max(0,Math.min(1,k)),e++}const R=Math.round(2*t/o),T=p.slice(S,S+R),d=B(T,o);if(c===v-1&&d>0&&h>0){const l=t-h;l>0&&A.push({bcl:l,apd:d})}d>0?h=d:h=0,j+=t}const P=[];for(let t=0;t<e;t+=K)f[t]!==void 0&&P.push({tempo:f[t].toFixed(2),v:p[t],h:w[t]});A.sort((t,c)=>t.bcl-c.bcl),self.postMessage({timeSeriesData:P,restitutionData:A})}})();
