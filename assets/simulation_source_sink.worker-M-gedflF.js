(function(){"use strict";class It{constructor(g=Date.now()){this.seed=g%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=this.seed*16807%2147483647,this.seed/2147483647}nextInt(g,D){return g>D&&([g,D]=[D,g]),Math.floor(this.next()*(D-g+1))+g}}const Rt={u_o:0,theta_v:.3,theta_w:.13,tau_vplus:1.4506,tau_s1:2.7342,k_s:2.0994,u_s:.9087};self.onmessage=ut=>{const g=ut.data,{modelType:D,sigma_l:tt,sigma_t:st,fiber_angle:qt,L:at,dx:l,totalTime:Ct,downsamplingFactor:mt,stimuli:St,obstacleParams:kt,slitParams:Jt,fibrosisParams:nt}=g,{Tau_in:Ht,Tau_out:Nt,Tau_open:Wt,Tau_close:Bt,gate:Et}=g,{cellType:Lt,minimalCellParams:ft}=g;let{dt:P}=g;const t=Math.floor(at/l),q=l,ht=qt*Math.PI/180,ot=Math.cos(ht),et=Math.sin(ht),dt=ot*ot,Mt=et*et,Ot=ot*et,z=tt*dt+st*Mt,G=tt*Mt+st*dt,K=(tt-st)*Ot,Ut=4*Math.max(z,G)+2*Math.abs(K),xt=l*l/(Ut||1);P>xt&&(P=xt*.9);let m=new Float32Array(t*t).fill(0),B=new Float32Array(t*t).fill(1),Q,V;D==="minimal"&&(Q=new Float32Array(t*t).fill(1),V=new Float32Array(t*t).fill(0));let H=new Float32Array(t*t).fill(z),N=new Float32Array(t*t).fill(G),W=new Float32Array(t*t).fill(K),y=new Float32Array(t*t).fill(1);if(nt&&nt.enabled){const{conductivity:a,type:f,distribution:F,shape:C,rectParams:I,circleParams:T,regionParams:J,borderZone:d=0,seed:o,density:c}=nt,s=(n,_,M)=>n*(1-M)+_*M;if(f==="compact"&&F==="region")if(C==="rectangle"){const{x1:n,y1:_,x2:M,y2:x}=I,b=Math.min(n,M),v=Math.max(n,M),S=Math.min(_,x),k=Math.max(_,x),j=Math.max(0,Math.floor((S-d)/q)),p=Math.min(t-1,Math.floor((k+d)/q)),h=Math.max(0,Math.floor((b-d)/l)),u=Math.min(t-1,Math.floor((v+d)/l));for(let i=j;i<=p;i++)for(let r=h;r<=u;r++){const A=i*q,R=r*l,w=i*t+r,L=Math.max(b-R,0,R-v),$=Math.max(S-A,0,A-k),O=Math.sqrt(L*L+$*$);if(O===0)H[w]=a,N[w]=a,W[w]=0,y[w]=a;else if(O<=d){const U=O/d;H[w]=s(a,z,U),N[w]=s(a,G,U),W[w]=s(0,K,U),y[w]=s(a,1,U)}}}else{const{cx:n,cy:_,radius:M}=T,x=M+d,b=Math.max(0,Math.floor((_-x)/q)),v=Math.min(t-1,Math.floor((_+x)/q)),S=Math.max(0,Math.floor((n-x)/l)),k=Math.min(t-1,Math.floor((n+x)/l));for(let j=b;j<=v;j++)for(let p=S;p<=k;p++){const h=j*q,u=p*l,i=j*t+p,r=Math.sqrt((u-n)**2+(h-_)**2);if(r<=M)H[i]=a,N[i]=a,W[i]=0,y[i]=a;else if(r<=x){const A=(r-M)/d;H[i]=s(a,z,A),N[i]=s(a,G,A),W[i]=s(0,K,A),y[i]=s(a,1,A)}}}else{const n=new It(o);let _,M,x,b,v;const S=l*q;if(f==="diffuse"&&J){const{x1:p,y1:h,x2:u,y2:i}=J;M=Math.floor(Math.min(h,i)/q),x=Math.floor(Math.max(h,i)/q),b=Math.floor(Math.min(p,u)/l),v=Math.floor(Math.max(p,u)/l);const r=Math.abs(u-p)*Math.abs(i-h);_=Math.ceil(r*c/S)}else M=0,x=t-1,b=0,v=t-1,_=Math.ceil(at*at*c/S);M=Math.max(0,M),x=Math.min(t-1,x),b=Math.max(0,b),v=Math.min(t-1,v);let k=0,j=0;for(;k<_&&j<_*5;){j++;const p=n.nextInt(M,x),h=n.nextInt(b,v),u=p*t+h;H[u]=a,N[u]=a,W[u]=0,y[u]=a,k++}}}const{cx:it,cy:rt,radius:X}=kt,{widthStart:pt,widthEnd:Zt}=Jt,zt=X*X,yt=rt-X,Gt=rt+X-yt;for(let a=0;a<t;a++)for(let f=0;f<t;f++){const F=a*t+f,C=a*l,I=f*l;let T=!0;if((I-it)**2+(C-rt)**2<=zt){const d=Math.max(0,Math.min(1,(C-yt)/Gt)),c=(pt+d*(Zt-pt))/2;I>=it-c&&I<=it+c?T=!0:T=!1}T||(H[F]=0,N[F]=0,W[F]=0,y[F]=0)}const wt=[],ct=[];let vt=0;St.forEach((a,f)=>{let F=new Uint8Array(t*t).fill(0);if(a.shape==="circle"){const{cx:T,cy:J,radius:d}=a.circleParams,o=d*d;for(let c=0;c<t;c++)for(let s=0;s<t;s++){const n=c*l;(s*l-T)**2+(n-J)**2<=o&&y[c*t+s]>0&&(F[c*t+s]=1)}}wt.push(F);let C=f===0?a.startTime:vt+a.interval;const I=C+a.duration;vt=I,ct.push({startTime:C,endTime:I,amplitude:a.amplitude})});const Z=Math.floor(Ct/P),gt=Math.floor(Z/mt)+1,lt=new Float32Array(gt*t*t),_t=new Float32Array(gt);let Y=0;const Kt=1/(4*l*l),bt=1/(l*l),Qt=Math.max(1,Math.floor(Z/100)),Vt=performance.now(),{u_o:Xt,theta_v:At,theta_w:Yt,tau_vplus:E,tau_s1:$t,k_s:ts,u_s:ss}=Rt,e=D==="minimal"?ft[Lt]||ft.epi:null;for(let a=0;a<Z;a++){if(a%Qt===0){const o=Math.round(a/Z*100);let c=0;if(a>0){const n=(performance.now()-Vt)/a;c=(Z-a)*n}self.postMessage({type:"progress",value:o,remaining:c})}const f=new Float32Array(m),F=new Float32Array(B),C=D==="minimal"?new Float32Array(Q):null,I=D==="minimal"?new Float32Array(V):null,T=a*P;let J=0,d=null;for(let o=0;o<ct.length;o++){const c=ct[o];if(T>=c.startTime&&T<c.endTime){J=c.amplitude,d=wt[o];break}}for(let o=1;o<t-1;o++)for(let c=1;c<t-1;c++){const s=o*t+c;if(y[s]===0){m[s]=-.1;continue}const n=f[s],_=F[s],M=H[s],x=N[s],b=W[s],v=d?d[s]*J:0,S=(f[s-1]-2*n+f[s+1])*bt,k=(f[s-t]-2*n+f[s+t])*bt,j=(f[s+t+1]-f[s+t-1]-f[s-t+1]+f[s-t-1])*Kt,p=M*S+x*k+2*b*j;if(D==="ms"){let h,u;n<Et?(h=1/Wt,u=0):(h=0,u=1/Bt);const i=h+u;if(i>0){const R=h/i,w=Math.exp(-i*P);B[s]=R+(_-R)*w}const r=_*n*n*(1-n)/Ht,A=-n/Nt;m[s]=n+P*(p+r+A+v),m[s]=Math.max(0,Math.min(1,m[s])),B[s]=Math.max(0,Math.min(1,B[s]))}else{const h=C[s],u=I[s],i=n-At>0?1:0,r=n-Yt>0?1:0,A=n-e.theta_vminus>0?1:0,R=n-e.theta_o>0?1:0,w=(1-A)*e.tau_v1minus+A*e.tau_v2minus,L=e.tau_w1minus+(e.tau_w2minus-e.tau_w1minus)*(1+Math.tanh(e.k_wminus*(n-e.u_wminus)))*.5,$=e.tau_so1+(e.tau_so2-e.tau_so1)*(1+Math.tanh(e.k_so*(n-e.u_so)))*.5,O=(1-r)*$t+r*e.tau_s2,U=(1-R)*e.tau_o1+R*e.tau_o2,as=-_*i*(n-At)*(e.u_u-n)/e.tau_fi,ns=(n-Xt)*(1-r)/U+r/$,os=-r*h*u/e.tau_si;m[s]=n+P*(p-(as+ns+os)+v);const es=n<e.theta_vminus?1:0,Ft=E*w/(E-E*i+w*i),Tt=E*es*(1-i)/(E-E*i+w*i);Ft>1e-10?B[s]=Tt+(_-Tt)*Math.exp(-P/Ft):B[s]=_;const is=(1-R)*(1-n/e.tau_winf)+R*e.w_infstar,jt=e.tau_wplus*L/(e.tau_wplus-e.tau_wplus*r+L*r),Dt=e.tau_wplus*is*(1-r)/(e.tau_wplus-e.tau_wplus*r+L*r);jt>1e-10?Q[s]=Dt+(h-Dt)*Math.exp(-P/jt):Q[s]=h;const Pt=(1+Math.tanh(ts*(n-ss)))*.5;O>1e-10?V[s]=Pt+(u-Pt)*Math.exp(-P/O):V[s]=u,m[s]<0&&(m[s]=0),m[s]>2&&(m[s]=2)}}for(let o=0;o<t;o++)y[o*t]>0&&(m[o*t]=m[o*t+1]),y[o*t+t-1]>0&&(m[o*t+t-1]=m[o*t+t-2]);for(let o=0;o<t;o++)y[o]>0&&(m[o]=m[t+o]),y[(t-1)*t+o]>0&&(m[(t-1)*t+o]=m[(t-2)*t+o]);a%mt===0&&(lt.set(m,Y*t*t),_t[Y]=T,Y++)}self.postMessage({type:"result",frames:lt,times:_t,fibrosis:y,N:t,totalFrames:Y},[lt.buffer,_t.buffer,y.buffer])}})();
