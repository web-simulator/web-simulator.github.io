(function(){"use strict";function P(n,s,l,o,r,c,a){for(let t=0;t<a;t++){const p=o+t*r;if(n>=p&&n<p+l)return s}const i=o+(a-1)*r+c;return n>=i&&n<i+l?s:0}function S(n){if(n.length===0)return 0;let s=-1/0,l=0,o=0;for(let t=0;t<n.length;t++)n[t].v>s&&(s=n[t].v,o=t);if(s<.05)return 0;const r=s-l,c=s-.9*r;let a=n[0].t,i=n[n.length-1].t;for(let t=o;t>=0;t--)if(n[t].v<c){a=n[t].t;break}for(let t=o;t<n.length;t++)if(n[t].v<c){i=n[t].t;break}return i-a}self.onmessage=n=>{const s=n.data,{despolarização:l,repolarização:o,recuperação:r,inativação:c,gate:a,dt:i,v_inicial:t,h_inicial:p,inicio:x,duração:j,amplitude:q,BCL_S1:h,intervalo_S2:g,num_estimulos_s1:M,downsamplingFactor:B}=s,C=x+(M-1)*h+g+2*h,f=parseInt(C/i,10),d=new Array(f),v=new Array(f),u=new Array(f);v[0]=t,u[0]=p,d[0]=0;const G=x+(M-1)*h+g;let b=0,D=[];for(let e=1;e<f;e++){d[e]=e*i;const k=d[e],K=P(k,q,j,x,h,g,M),_=v[e-1],w=u[e-1],L=w*_**2*(1-_)/l,N=-_/o,y=L+N+K,J=_+y*i;k>=G&&(y>b&&(b=y),D.push({t:k,v:J}));let m,A;_<a?(m=1/r,A=0):(m=0,A=1/c);const I=m+A;let z;if(I>0){const E=m/I,O=Math.exp(-I*i);z=E+(w-E)*O}else z=w;v[e]=Math.max(0,Math.min(1,J)),u[e]=Math.max(0,Math.min(1,z))}const H=S(D),F=[];for(let e=0;e<f;e+=B)F.push({tempo:d[e]?.toFixed(2),v:v[e],h:u[e]});self.postMessage({data:F,metrics:{dvdtMax:b,apd:H}})}})();
