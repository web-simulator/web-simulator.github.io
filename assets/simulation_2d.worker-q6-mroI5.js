(function(){"use strict";class gt{constructor(A=Date.now()){this.seed=A%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=this.seed*16807%2147483647,this.seed/2147483647}nextInt(A,b){return A>b&&([A,b]=[b,A]),Math.floor(this.next()*(b-A+1))+A}}self.onmessage=nt=>{const A=nt.data,{sigma_l:b,sigma_t:W,angle:bt,Tau_in:wt,Tau_out:vt,Tau_open:jt,Tau_close:Tt,gate:rt,L:X,N:t,totalTime:At,downsamplingFactor:it,stimuli:Ft,fibrosisParams:Y,transmuralityParams:q}=A;let{dt:k}=A;const l=X/t,y=l,ct=bt*Math.PI/180,$=Math.cos(ct),tt=Math.sin(ct),lt=$*$,ft=tt*tt,Dt=$*tt,G=b*lt+W*ft,H=b*ft+W*lt,K=(b-W)*Dt,Pt=4*Math.max(G,H)+2*Math.abs(K),mt=l*l/(Pt||1);k>mt&&(k=mt*.9);const F=t*t;let _=new Float32Array(F).fill(0),w=new Float32Array(F).fill(1),z=new Float32Array(F).fill(G),E=new Float32Array(F).fill(H),L=new Float32Array(F).fill(K),B=new Float32Array(F).fill(b);if(Y&&Y.enabled){const{conductivity:a,type:x,distribution:C,shape:R,rectParams:J,circleParams:D,regionParams:s,borderZone:o=0,seed:e,density:i}=Y,c=(m,f,n)=>m+(f-m)*n;if(x==="compact"&&C==="region")if(R==="rectangle"){const{x1:m,y1:f,x2:n,y2:r}=J,d=Math.min(m,n),p=Math.max(m,n),P=Math.min(f,r),v=Math.max(f,r),j=d-o,M=p+o,T=P-o,u=v+o,h=Math.max(0,Math.floor(T/y)),I=Math.min(t-1,Math.floor(u/y)),g=Math.max(0,Math.floor(j/l)),Z=Math.min(t-1,Math.floor(M/l));for(let N=h;N<=I;N++)for(let Q=g;Q<=Z;Q++){const Mt=N*y,ut=Q*l,S=N*t+Q,pt=Math.max(d-ut,0,ut-p),yt=Math.max(P-Mt,0,Mt-v),ot=Math.sqrt(pt*pt+yt*yt);if(ot===0)z[S]=a,E[S]=a,L[S]=0,B[S]=a;else if(ot<=o){const V=ot/o;z[S]=c(a,G,V),E[S]=c(a,H,V),L[S]=c(0,K,V),B[S]=c(a,b,V)}}}else{const{cx:m,cy:f,radius:n}=D,r=n+o,d=Math.max(0,Math.floor((f-r)/y)),p=Math.min(t-1,Math.floor((f+r)/y)),P=Math.max(0,Math.floor((m-r)/l)),v=Math.min(t-1,Math.floor((m+r)/l));for(let j=d;j<=p;j++)for(let M=P;M<=v;M++){const T=j*y,u=M*l,h=j*t+M,I=Math.sqrt((u-m)**2+(T-f)**2);if(I<=n)z[h]=a,E[h]=a,L[h]=0,B[h]=a;else if(I<=r){const g=(I-n)/o;z[h]=c(a,G,g),E[h]=c(a,H,g),L[h]=c(0,K,g),B[h]=c(a,b,g)}}}else{const m=new gt(e);let f,n,r,d,p;const P=l*y;if(x==="diffuse"&&s){const{x1:M,y1:T,x2:u,y2:h}=s;n=Math.floor(Math.min(T,h)/y),r=Math.floor(Math.max(T,h)/y),d=Math.floor(Math.min(M,u)/l),p=Math.floor(Math.max(M,u)/l);const I=Math.abs(u-M)*Math.abs(h-T);f=Math.ceil(I*i/P)}else n=0,r=t-1,d=0,p=t-1,f=Math.ceil(X*X*i/P);n=Math.max(0,n),r=Math.min(t-1,r),d=Math.max(0,d),p=Math.min(t-1,p);let v=0,j=0;for(;v<f&&j<f*5;){j++;const M=m.nextInt(n,r),T=m.nextInt(d,p),u=M*t+T;z[u]=a,E[u]=a,L[u]=0,B[u]=a,v++}}}const ht=[],st=[];let _t=0;Ft.forEach((a,x)=>{let C=new Uint8Array(F).fill(0);if(a.shape==="rectangle"){const{x1:D,y1:s,x2:o,y2:e}=a.rectParams,i=Math.floor(s/y),c=Math.floor(D/l),m=Math.floor(e/y),f=Math.floor(o/l);for(let n=Math.min(i,m);n<=Math.max(i,m);n++)for(let r=Math.min(c,f);r<=Math.max(c,f);r++)n>=0&&n<t&&r>=0&&r<t&&(C[n*t+r]=1)}else{const{cx:D,cy:s,radius:o}=a.circleParams,e=o*o;for(let i=0;i<t;i++)for(let c=0;c<t;c++)(c*l-D)**2+(i*y-s)**2<=e&&(C[i*t+c]=1)}ht.push(C);let R=x===0?a.startTime:_t+a.interval;const J=R+a.duration;_t=J,st.push({startTime:R,endTime:J,amplitude:a.amplitude})});const U=Math.floor(At/k),dt=Math.floor(U/it)+1,at=new Float32Array(dt*F),et=new Float32Array(dt);let O=0;const xt=1/(l*l),It=1/(4*l*l),Rt=Math.max(1,Math.floor(U/100)),St=performance.now();for(let a=0;a<U;a++){if(a%Rt===0){const s=Math.round(a/U*100);let o=0;if(a>0){const e=performance.now()-St;o=(U-a)*(e/a)}self.postMessage({type:"progress",value:s,remaining:o})}const x=new Float32Array(_),C=new Float32Array(w),R=a*k;let J=0,D=null;for(let s=0;s<st.length;s++){const o=st[s];if(R>=o.startTime&&R<o.endTime){J=o.amplitude,D=ht[s];break}}for(let s=1;s<t-1;s++)for(let o=1;o<t-1;o++){const e=s*t+o,i=x[e],c=C[e],m=z[e],f=E[e],n=L[e],r=D?D[e]*J:0;let d=Tt;if(q&&q.enabled){const g=o/t,Z=q.mid_start/100,N=q.epi_start/100;g<Z?d=q.endo_tau:g<N?d=q.mid_tau:d=q.epi_tau}let p=i<rt?1/jt:0,P=i<rt?0:1/d;const v=p+P;if(v>1e-10){const g=p/v,Z=Math.exp(-v*k);w[e]=g+(c-g)*Z}else w[e]=c;const j=(x[e-1]-2*i+x[e+1])*xt,M=(x[e-t]-2*i+x[e+t])*xt,T=(x[e+t+1]-x[e+t-1]-x[e-t+1]+x[e-t-1])*It,u=m*j+f*M+2*n*T,h=c*i*i*(1-i)/wt,I=-i/vt;_[e]=i+k*(u+h+I+r),_[e]<0&&(_[e]=0),_[e]>1.5&&(_[e]=1.5)}for(let s=0;s<t;s++)_[s*t]=_[s*t+1],_[s*t+t-1]=_[s*t+t-2],w[s*t]=w[s*t+1],w[s*t+t-1]=w[s*t+t-2];for(let s=0;s<t;s++)_[s]=_[t+s],_[(t-1)*t+s]=_[(t-2)*t+s],w[s]=w[t+s],w[(t-1)*t+s]=w[(t-2)*t+s];a%it===0&&(at.set(_,O*F),et[O]=R,O++)}self.postMessage({type:"result",frames:at,times:et,fibrosis:B,N:t,totalFrames:O},[at.buffer,et.buffer,B.buffer])}})();
