(function(){"use strict";function F(e,l){if(!e||e.length===0)return 0;const c=Math.max(...e),x=Math.min(...e),h=c-x;if(h<.2)return 0;const v=c-h*.9;let t=-1,i=-1;for(let n=0;n<e.length;n++)if(e[n]>=c*.98){t=n;break}if(t===-1)return 0;for(let n=t;n<e.length;n++)if(e[n]<=v){i=n;break}return i===-1?0:(i-t)*l}function q(e){const{tau_in:l,tau_out:c,tau_open:x,tau_close:h,v_gate:v,dt:t,v_inicial:i,h_inicial:n,inicio:_,duracao:r,amplitude:u,BCL_S1:s,intervalo_S2:b,num_estimulos_s1:d}=e,S=0,A=v,m=_+(d-1)*s+b+1.5*s,p=parseInt(m/t,10),f=new Array(p).fill(i),o=new Array(p).fill(n),D=new Array(p);for(let a=1;a<p;a++){D[a]=a*t;const y=D[a];let L=0;for(let g=0;g<d;g++){const w=_+g*s;if(y>=w&&y<w+r){L=u;break}}const T=_+(d-1)*s+b;y>=T&&y<T+r&&(L=u);const M=f[a-1],k=o[a-1],H=k*(M+S)*(M+S-A)*(1-M)/l,K=-M/c,N=H+K+L,O=M+N*t;let C,B;M<v?(C=1/x,B=0):(C=0,B=1/h);const I=C+B;let z;if(I>0){const g=C/I,w=Math.exp(-I*t);z=g+(k-g)*w}else z=k;f[a]=Math.max(0,Math.min(1,O)),o[a]=Math.max(0,Math.min(1,z))}const J=Math.round((_+(d-1)*s)/t),P=Math.round((_+(d-1)*s+b)/t),j=Math.round(1.5*s/t),E=f.slice(J,J+j),G=f.slice(P,P+j);return{v_s1:E,v_s2:G,full_v:f,full_h:o,full_tempo:D}}self.onmessage=e=>{const l=e.data,{BCL_S2_inicial:c,BCL_S2_final:x,delta_CL:h,downsamplingFactor:v}=l,t=Math.floor((c-x)/h)+1,i=[],n=[];let _=0;for(let r=0;r<t;r++){const u=c-r*h;if(u<x)continue;const s={...l,intervalo_S2:u},{v_s1:b,v_s2:d,full_v:S,full_h:A,full_tempo:m}=q(s),p=F(b,l.dt),f=F(d,l.dt);if(p>0&&f>0){const o=u-p;o>0&&i.push({bcl:o,apd:f})}for(let o=0;o<S.length;o+=v)m[o]!==void 0&&n.push({tempo:(_+m[o]).toFixed(2),v:S[o],h:A[o]});m.length>0&&(_+=m[m.length-1])}i.sort((r,u)=>r.bcl-u.bcl),self.postMessage({timeSeriesData:n,restitutionData:i})}})();
